rules_version = '2';

// Firebase Storage Security Rules for ScanXR
service firebase.storage {
  match /b/{bucket}/o {
    
    // Models directory - GLB/GLTF files
    match /models/{userId}/{fileName} {
      // Allow read for all authenticated users
      allow read: if request.auth != null;
      
      // Allow write only for the owner
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && isValidModelFile();
    }
    
    // Thumbnails directory - Image files
    match /thumbnails/{userId}/{fileName} {
      // Allow read for all users (thumbnails can be public)
      allow read;
      
      // Allow write only for the owner
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && isValidImageFile();
    }
    
    // Helper functions
    function isValidModelFile() {
      return resource == null // New file
             && request.resource.size < 50 * 1024 * 1024 // Max 50MB
             && request.resource.contentType.matches('.*/(gltf|octet-stream).*'); // GLB/GLTF files
    }
    
    function isValidImageFile() {
      return resource == null // New file
             && request.resource.size < 5 * 1024 * 1024 // Max 5MB
             && request.resource.contentType.matches('image/.*'); // Image files only
    }
  }
}